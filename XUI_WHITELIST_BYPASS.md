# Настройка x-ui для обхода российских белых списков

Это руководство поможет настроить x-ui панель для обхода российских белых списков и блокировок.

## Быстрый старт

```bash
sudo /var/playroom/setup_xui_whitelist_bypass.sh
```

## Что делает скрипт

1. **Обновляет geo файлы** - актуальные списки стран и доменов
2. **Создает routing rules** - правила маршрутизации трафика
3. **Настраивает DNS** - использование DoH для обхода блокировок DNS
4. **Генерирует конфигурации** - готовые JSON файлы для вставки в панель

## Ручная настройка через веб-панель

### 1. Настройка Routing (Маршрутизация)

1. Войдите в веб-панель x-ui (обычно `http://your-server-ip:54321`)
2. Перейдите в **Settings** → **Routing**
3. Скопируйте содержимое из `/tmp/xui_routing_config.json`
4. Вставьте в поле конфигурации
5. Нажмите **Save**

**Что делают правила:**
- `geosite:ru` → прямой доступ (direct) для российских сайтов
- `geoip:ru` → прямой доступ для российских IP
- `geosite:white-list` → проксирование для ресурсов из белых списков
- Все остальные домены → проксирование через VPN/прокси
- Блокировка рекламы и торрентов

### 2. Настройка DNS

1. Перейдите в **Settings** → **DNS**
2. Скопируйте содержимое из `/tmp/xui_dns_config.json`
3. Вставьте в поле конфигурации
4. Нажмите **Save**

**Что делают настройки:**
- Использует Yandex DNS (77.88.8.8, 77.88.8.1) для российских доменов
- Использует Cloudflare DoH (1.1.1.1) для международных доменов
- Использует Google DNS (8.8.8.8) как резервный через DoH/TLS
- Обход блокировок DNS через зашифрованные запросы

### 3. Настройка Inbound (Входящие подключения)

Для лучшего обхода блокировок рекомендуется:

1. **Использовать VLESS или VMESS** с TLS
2. **Включить WebSocket** или **gRPC** транспорт
3. **Использовать домены** вместо IP адресов
4. **Настроить Path** для WebSocket (например: `/ws` или `/v2ray`)

**Пример настройки VLESS с WebSocket:**
- Protocol: VLESS
- Port: 443
- Network: ws (WebSocket)
- Path: `/v2ray`
- TLS: true
- SNI: ваш домен

### 4. Настройка Fallback (Резервные маршруты)

Для обхода блокировок по SNI:

1. Перейдите в **Settings** → **Inbound**
2. Добавьте **Fallback** настройки:
   - Dest: 80
   - Path: `/`
   - Status Code: 200
   - Content: `<html><body>Welcome</body></html>`

## Автоматическая настройка через API

Если у вас есть доступ к API x-ui:

```bash
# Установите зависимости
pip3 install requests

# Запустите скрипт
python3 /tmp/xui_api_setup.py http://localhost:54321
```

Вам будет предложено ввести логин и пароль от панели.

## Специфика обхода российских белых списков

### Как работают белые списки в России

В России белые списки означают, что доступ разрешен только к определенным доменам/ресурсам, а все остальное блокируется на уровне провайдера. Для обхода необходимо:

1. **Все российские ресурсы** идут напрямую (direct) - это разрешенные домены
2. **Все остальные ресурсы** идут через прокси - это обход блокировок
3. **DNS запросы** для международных доменов идут через DoH/DoT для обхода блокировок DNS

### Настройка для работы с белыми списками

Конфигурация автоматически настроена так:
- ✅ Российские домены (`geosite:ru`) → прямой доступ
- ✅ Российские IP (`geoip:ru`) → прямой доступ  
- ✅ Все остальное → через прокси
- ✅ DNS для РФ через Yandex DNS
- ✅ DNS для остальных через Cloudflare/Google DoH

### Важные моменты

1. **Порт 443 (HTTPS)** - используйте для лучшей маскировки
2. **TLS обязателен** - для обхода DPI
3. **WebSocket или gRPC** - для лучшей маскировки трафика
4. **Домены вместо IP** - используйте доменные имена для серверов

## Продвинутые настройки

### Обход блокировок по DPI (Deep Packet Inspection)

1. **Используйте VLESS Reality** или **VMESS + TLS**
2. **Настройте Fake SNI** - используйте популярные домены (например, `www.microsoft.com`)
3. **Включите TLS Fingerprint** - используйте реальные отпечатки браузеров

### Дополнительные техники обхода для российских белых списков

1. **Используйте порт 443** (HTTPS) - стандартный порт для HTTPS трафика
2. **Настройте маскировку под обычный HTTPS трафик** - используйте реальные SNI
3. **Используйте CDN** (Cloudflare, AWS CloudFront) для маскировки
4. **Настройте VLESS Reality** - для обхода DPI и блокировок
5. **Используйте домены** вместо IP адресов
6. **Настройте Fallback** - для обхода блокировок по SNI
7. **Регулярно обновляйте** - geo файлы и сам x-ui

### Оптимизация производительности

1. **Включите Mux** в настройках клиента
2. **Используйте UDP** для лучшей производительности
3. **Настройте Buffer Size** для вашего канала

## Обновление конфигураций

Регулярно обновляйте geo файлы:

```bash
x-ui update-all-geofiles
```

После обновления перезапустите x-ui:

```bash
x-ui restart
```

## Проверка работы

1. **Проверьте логи:**
   ```bash
   x-ui log
   ```

2. **Проверьте статус:**
   ```bash
   x-ui status
   ```

3. **Протестируйте подключение** с клиента

4. **Проверьте работу с белыми списками:**
   - Откройте российский сайт (например, yandex.ru) - должен открываться напрямую
   - Откройте зарубежный сайт (например, google.com) - должен открываться через прокси
   - Проверьте DNS: `nslookup google.com` - должен резолвиться через DoH

## Устранение проблем

### Проблема: Не работает обход блокировок

**Решения:**
- Проверьте, что routing rules применены
- Убедитесь, что geo файлы обновлены
- Попробуйте другой протокол (VLESS вместо VMESS)
- Измените порт на 443 или 80

### Проблема: Медленная скорость

**Решения:**
- Отключите Mux если он включен
- Проверьте настройки DNS
- Убедитесь, что routing rules не перенаправляют весь трафик через прокси

### Проблема: DNS не работает

**Решения:**
- Проверьте настройки DNS в панели
- Убедитесь, что DoH серверы доступны
- Попробуйте использовать обычные DNS серверы

## Безопасность

1. **Измените пароль по умолчанию** в панели x-ui
2. **Используйте сильные пароли** для пользователей
3. **Ограничьте доступ к панели** по IP (если возможно)
4. **Регулярно обновляйте** x-ui: `x-ui update`

## Полезные команды

```bash
# Статус x-ui
x-ui status

# Запуск
x-ui start

# Остановка
x-ui stop

# Перезапуск
x-ui restart

# Просмотр логов
x-ui log

# Обновление
x-ui update

# Обновление geo файлов
x-ui update-all-geofiles

# Включить автозапуск
x-ui enable
```

## Дополнительные ресурсы

- [Xray-core документация](https://xtls.github.io/)
- [x-ui GitHub](https://github.com/vaxilu/x-ui)
- [V2Ray документация](https://www.v2fly.org/)

## Примечания

- Настройки могут отличаться в зависимости от версии x-ui
- Некоторые функции требуют определенной версии Xray-core
- Всегда делайте резервные копии конфигураций перед изменениями
