name: Deploy

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð´
  ci-checks:
    name: Run CI Checks Before Deploy
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Quick syntax check
      run: |
        python -m py_compile main.py config.py
        find handlers utils db repositories services -name "*.py" -type f -exec python -m py_compile {} \;

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [ci-checks]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        mkdir -p deploy
        tar -czf deploy/bot.tar.gz \
          --exclude='venv' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.git' \
          --exclude='tmp' \
          --exclude='exports' \
          --exclude='bot.log' \
          --exclude='.env' \
          main.py config.py handlers/ utils/ db/ repositories/ services/ keyboards/ util_types/ requirements.txt start_bot.sh ci_check.sh
        echo "âœ… Deployment package created"

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: bot-deployment
        path: deploy/bot.tar.gz
        retention-days: 7

    # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹ ÑÐµÐºÑ€ÐµÑ‚Ñ‹)
    - name: Deploy to server via SSH
      if: secrets.DEPLOY_ENABLED == 'true' && secrets.DEPLOY_HOST != ''
      uses: appleboy/scp-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        source: "deploy/bot.tar.gz"
        target: "/var/playroom"
        strip_components: 0

    - name: Execute deployment script on server
      if: secrets.DEPLOY_ENABLED == 'true' && secrets.DEPLOY_HOST != ''
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        script: |
          cd /var/playroom
          
          echo "ðŸ“¦ Extracting deployment package..."
          tar -xzf bot.tar.gz -C . --strip-components=0 || {
            # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð¼
            tar -xzf bot.tar.gz
          }
          
          echo "ðŸ“¦ Installing/updating dependencies..."
          if [ -d "venv" ]; then
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          else
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          fi
          
          echo "ðŸ”„ Restarting bot..."
          chmod +x start_bot.sh
          ./start_bot.sh
          
          echo "âœ… Deployment completed!"
          echo "ðŸ“ Checking bot status..."
          sleep 3
          if ps aux | grep -q "[p]ython.*main.py"; then
            echo "âœ… Bot is running"
          else
            echo "âš ï¸  Bot might not be running, check logs: tail -f /var/playroom/bot.log"
          fi

    - name: Deployment summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ secrets.DEPLOY_ENABLED }}" == "true" ] && [ -n "${{ secrets.DEPLOY_HOST }}" ]; then
          echo "âœ… **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ð‘Ð¾Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½." >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ: \`tail -f /var/playroom/bot.log\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸  **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ð”Ð»Ñ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ GitHub Secrets (ÑÐ¼. [DEPLOYMENT.md](.github/DEPLOYMENT.md)):" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEPLOY_ENABLED\` = \`true\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEPLOY_HOST\` - Ð°Ð´Ñ€ÐµÑ ÑÐµÑ€Ð²ÐµÑ€Ð°" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEPLOY_USER\` - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ SSH" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEPLOY_SSH_KEY\` - Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡" >> $GITHUB_STEP_SUMMARY
          echo "- \`DEPLOY_PORT\` - Ð¿Ð¾Ñ€Ñ‚ SSH (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 22)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Ð˜Ð»Ð¸ ÑÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ \`bot-deployment\` Ð¸ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:" >> $GITHUB_STEP_SUMMARY
          echo "1. \`tar -xzf bot.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "2. \`pip install -r requirements.txt\`" >> $GITHUB_STEP_SUMMARY
          echo "3. \`./start_bot.sh\`" >> $GITHUB_STEP_SUMMARY
        fi
