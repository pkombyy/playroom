#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞

cd "$(dirname "$0")"

echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞..."
pkill -9 -f "python.*main.py" 2>/dev/null
killall -9 Python python python3 2>/dev/null
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
if ps aux | grep -q "[p]ython.*main.py"; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:"
    ps aux | grep "[p]ython.*main.py"
    echo "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º!"
    exit 1
fi

echo "‚úÖ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
source venv/bin/activate
nohup python main.py > bot.log 2>&1 &
BOT_PID=$!

sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
if kill -0 $BOT_PID 2>/dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω! (PID: $BOT_PID)"
    echo "üìù –õ–æ–≥–∏: tail -f bot.log"
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞: kill $BOT_PID –∏–ª–∏ pkill -f 'python.*main.py'"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
    if tail -20 bot.log | grep -q "ERROR"; then
        echo "‚ö†Ô∏è  –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: tail bot.log"
    fi
else
    echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "   tail -50 bot.log"
    tail -30 bot.log | strings
    exit 1
fi
